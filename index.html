<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QR Maker</title>
<script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: #f5f5f7;
  min-height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 20px;
}
.container {
  background: white;
  border-radius: 16px;
  padding: 32px;
  max-width: 480px;
  width: 100%;
  box-shadow: 0 4px 24px rgba(0,0,0,0.08);
}
h1 {
  font-size: 1.5rem;
  margin-bottom: 24px;
  text-align: center;
}
.field { margin-bottom: 16px; }
label {
  display: block;
  font-size: 0.85rem;
  font-weight: 600;
  color: #555;
  margin-bottom: 4px;
}
input {
  width: 100%;
  padding: 10px 12px;
  border: 1.5px solid #ddd;
  border-radius: 8px;
  font-size: 1rem;
  transition: border-color 0.2s;
}
input:focus {
  outline: none;
  border-color: #4a90d9;
}
button {
  width: 100%;
  padding: 12px;
  background: #4a90d9;
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  margin-top: 8px;
  transition: background 0.2s;
}
button:hover { background: #3a7bc8; }
#qr-output {
  margin-top: 24px;
  text-align: center;
  display: none;
}
#qr-preview {
  border: 1px solid #ddd;
  border-radius: 4px;
  max-width: 100%;
}
#generated-url {
  margin-top: 12px;
  font-size: 0.75rem;
  color: #888;
  word-break: break-all;
}
.btn-group {
  display: flex;
  gap: 8px;
  justify-content: center;
  margin-top: 12px;
}
.download-btn {
  display: inline-block;
  padding: 8px 24px;
  color: white;
  border-radius: 8px;
  text-decoration: none;
  font-weight: 600;
  font-size: 0.9rem;
  cursor: pointer;
}
.download-btn.svg { background: #4a90d9; }
.download-btn.svg:hover { background: #3a7bc8; }
.download-btn.png { background: #34c759; }
.download-btn.png:hover { background: #2db84d; }
</style>
</head>
<body>
<div class="container">
  <h1>üî≤ QR Maker</h1>
  <div class="field">
    <label for="url">URL</label>
    <input type="url" id="url" placeholder="https://example.com">
  </div>
  <div class="field">
    <label for="param-c">ÁîüÂçî„Ç≥„Éº„Éâ</label>
    <input type="text" id="param-c" placeholder="ÂÄ§„ÇíÂÖ•Âäõ">
  </div>
  <div class="field">
    <label for="param-source">utm_source</label>
    <input type="text" id="param-source" placeholder="‰æã: google">
  </div>
  <div class="field">
    <label for="param-medium">utm_medium</label>
    <input type="text" id="param-medium" placeholder="‰æã: cpc">
  </div>
  <div class="field">
    <label for="param-campaign">utm_campaign</label>
    <input type="text" id="param-campaign" placeholder="‰æã: spring2026">
  </div>
  <div class="field">
    <label for="qr-size">QR„Ç≥„Éº„Éâ„Çµ„Ç§„Ç∫Ôºà„Éî„ÇØ„Çª„É´Ôºâ</label>
    <input type="number" id="qr-size" value="500" min="64" max="2048" step="1">
  </div>
  <button onclick="generateQR()">QR„Ç≥„Éº„Éâ„ÇíÁîüÊàê</button>
  <div id="qr-output">
    <img id="qr-preview" />
    <p id="generated-url"><a id="generated-url-link" href="#" target="_blank" rel="noopener" style="color:#4a90d9;word-break:break-all;font-size:0.75rem;"></a></p>
    <div class="btn-group">
      <a id="download-svg" class="download-btn svg" download="qrcode.svg">SVG„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ</a>
      <a id="download-png" class="download-btn png" download="qrcode.png">PNG„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ</a>
    </div>
  </div>
</div>
<script>
function generateQR() {
  const url = document.getElementById('url').value.trim();
  if (!url) { alert('URL„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }

  const params = [];
  const c = document.getElementById('param-c').value.trim();
  const source = document.getElementById('param-source').value.trim();
  const medium = document.getElementById('param-medium').value.trim();
  const campaign = document.getElementById('param-campaign').value.trim();

  // Validate: UTM params must be ASCII only (no Japanese)
  const asciiOnly = /^[\x20-\x7E]*$/;
  if (source && !asciiOnly.test(source)) { alert('utm_source „Å´Êó•Êú¨Ë™û„ÅØ‰Ωø„Åà„Åæ„Åõ„Çì'); return; }
  if (medium && !asciiOnly.test(medium)) { alert('utm_medium „Å´Êó•Êú¨Ë™û„ÅØ‰Ωø„Åà„Åæ„Åõ„Çì'); return; }
  if (campaign && !asciiOnly.test(campaign)) { alert('utm_campaign „Å´Êó•Êú¨Ë™û„ÅØ‰Ωø„Åà„Åæ„Åõ„Çì'); return; }

  if (c) params.push('c=' + encodeURIComponent(c));
  if (source) params.push('utm_source=' + encodeURIComponent(source));
  if (medium) params.push('utm_medium=' + encodeURIComponent(medium));
  if (campaign) params.push('utm_campaign=' + encodeURIComponent(campaign));

  // Handle anchor (#) in URL: params go before the hash
  let base = url;
  let hash = '';
  const hashIdx = url.indexOf('#');
  if (hashIdx !== -1) {
    base = url.substring(0, hashIdx);
    hash = url.substring(hashIdx);
  }
  const sep = base.includes('?') ? '&' : '?';
  const fullUrl = params.length > 0 ? base + sep + params.join('&') + hash : url;
  const size = parseInt(document.getElementById('qr-size').value) || 500;

  const qr = qrcode(0, 'M');
  qr.addData(fullUrl);
  qr.make();

  const moduleCount = qr.getModuleCount();
  const padding = 15;

  // --- SVG generation ---
  const svgSize = size;
  const qrArea = svgSize - padding * 2;
  const cellSize = qrArea / moduleCount;
  let rects = '';
  for (let row = 0; row < moduleCount; row++) {
    for (let col = 0; col < moduleCount; col++) {
      if (qr.isDark(row, col)) {
        const x = padding + col * cellSize;
        const y = padding + row * cellSize;
        rects += `<rect x="${x}" y="${y}" width="${cellSize}" height="${cellSize}" fill="#000"/>`;
      }
    }
  }
  const svgStr = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ${svgSize} ${svgSize}" width="${svgSize}" height="${svgSize}"><rect width="${svgSize}" height="${svgSize}" fill="#fff"/>${rects}</svg>`;
  const svgBlob = new Blob([svgStr], { type: 'image/svg+xml' });
  const svgUrl = URL.createObjectURL(svgBlob);

  // Preview using SVG
  const preview = document.getElementById('qr-preview');
  preview.src = svgUrl;
  preview.width = Math.min(size, 300);
  preview.height = Math.min(size, 300);

  // SVG download (use data URL for reliable download)
  const svgDataUrl = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svgStr);
  const svgLink = document.getElementById('download-svg');
  svgLink.href = svgDataUrl;
  svgLink.onclick = function(e) {
    const a = document.createElement('a');
    a.href = svgDataUrl;
    a.download = 'qrcode.svg';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    e.preventDefault();
  };

  // --- PNG generation ---
  const canvas = document.createElement('canvas');
  canvas.width = size;
  canvas.height = size;
  const ctx = canvas.getContext('2d');
  ctx.fillStyle = '#ffffff';
  ctx.fillRect(0, 0, size, size);
  ctx.fillStyle = '#000000';
  for (let row = 0; row < moduleCount; row++) {
    for (let col = 0; col < moduleCount; col++) {
      if (qr.isDark(row, col)) {
        ctx.fillRect(
          Math.floor(padding + col * cellSize),
          Math.floor(padding + row * cellSize),
          Math.ceil(cellSize),
          Math.ceil(cellSize)
        );
      }
    }
  }
  const pngLink = document.getElementById('download-png');
  pngLink.href = canvas.toDataURL('image/png');
  pngLink.onclick = function(e) {
    const a = document.createElement('a');
    a.href = this.href;
    a.download = 'qrcode.png';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    e.preventDefault();
  };

  // URL link
  const urlLink = document.getElementById('generated-url-link');
  urlLink.href = fullUrl;
  urlLink.textContent = fullUrl;

  document.getElementById('qr-output').style.display = 'block';
}
</script>
</body>
</html>
